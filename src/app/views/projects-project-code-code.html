<!--
  ~ © 2015-2016 Becki Authors. See the AUTHORS file found in the top-level
  ~ directory of this distribution.
  -->

<bk-layout-main
     [tabMenu]="(project_Id == null ? 'byzance-admin' : 'projects-project')"
     [show_title]="!project_Id"
     [title]="project_Id == null ? ('main_title'|bkTranslate:this) : currentParamsService.currentProjectNameSnapshot"
     [subtitle]="project_Id == null ? ('main_subtitle'|bkTranslate:this) : currentParamsService.currentProjectDescriptionSnapshot">

    <!-- Portlet - Basic Title of Panel with Buttons on right side -- START -->
    <bk-portlet-title *ngIf="codeProgram"
        [title_name]="'title'|bkTranslate:this"
        [title_object_name]="codeProgram.name"
        [title_object_description]="codeProgram.description"
        [icon]="'fa-tachometer'"
        (onClick)="onPortletClick($event)"
        [btns]="[
             {
                  condition: (codeProgram && codeProgram.update_permission),
                  btn_label_for_person: ('label_program_properties'|bkTranslate:this),
                  icon: 'fa-cog',
                  permission: (codeProgram && codeProgram.update_permission),
                  colorType: 'EDIT',
                  btn_tag: 'edit_program'
             },
             {
                  condition: (codeProgram && codeProgram.delete_permission),
                  btn_label_for_person: ('label_remove_program'|bkTranslate:this),
                  icon: 'fa-trash',
                  permission: (codeProgram && codeProgram.delete_permission),
                  colorType: 'REMOVE',
                  btn_tag: 'remove_program'
             },
             {
                  condition: (codeProgram && codeProgram.publish_type == 'PUBLIC'),
                  btn_label_for_person: ('label_make_copy'|bkTranslate:this),
                  icon: 'fa-clone',
                  permission: (true),
                  colorType: 'CLONE',
                  btn_tag: 'make_clone'
             }
            ]"
        (onTabClick)="onToggleTab($event)"
        [tab_selected_name] = "tab"
        [tabBtns]="[
            {
                tab_name: 'ide',
                tab_color: 'CODE',
                tab_label: ('tab_ide'|bkTranslate:this)
            }
            ]">
    </bk-portlet-title>
    <!-- Portlet - Basic Title of Panel with Buttons on right side --- END -->


    <!-- Page Content IDE -- START -->
    <div class="portlet-body">

        <div class="portlet-title">
            <div *ngIf="selectedProgramVersion" class="becki-caption version">
                <span class="caption-subject font-gray"><strong>{{'label_version'|bkTranslate:this}}:</strong>
                    <span *ngIf="changesInSelectedVersion().length > 0" class="changes"></span>{{selectedProgramVersion.name}}</span>
            </div>
        </div>

        <!--- IDE START -->
        <bk-code-ide [files]="selectedCodeFiles"
                     [defaultOpenFilename]="'main.cpp'"
                     (fileContentChange)="onFileContentChange($event)"
                     [enableLibraryButtons]="true"
                     [enableSaveButton]="codeProgram && codeProgram.update_permission"
                     [enableBuildButton]="true"
                     [buildInProgress]="buildInProgress"
                     (onBuildClick)="onBuildClick()"
                     (onSaveClick)="onSaveClick()"
                     (onAddLibraryClick)="onAddLibraryClick()"
                     (onAddHardwareClick)="onAddDeveloperHardwareClick()"
                     (onChangeLibraryVersionClick)="onChangeLibraryVersionClick($event)">
        </bk-code-ide>
        <!--- IDE END -->

        <!--- Under IDE -->
        <div>
            <span *ngIf="codeProgram && codeProgram.publish_type == 'PUBLIC'" class="text-center" style="margin-top: 10px; margin-bottom: 20px">{{'label_public_comment'|bkTranslate:this}}</span>
            <div class="pull-right">
                <div>
                    <span><strong>{{'label_library_version'|bkTranslate:this}}: </strong></span>
                    <bk-form-select [control]="formLibrarySelector.controls.tag_name" [labelComment]="false"
                                    [regexFirstOption]="'[v][0-9.]*(?![-])$'" [options]="libraryCompilationVersionOptions"></bk-form-select>
                </div>
            </div>
            <div class="clearfix">
            </div>
        </div>
    </div>
    <!-- Page Content IDE -- END -->


    <!-- Page Content UNDER IDE -- START -->
    <div class="portlet-body">

        <!-- Portlet - Basic Title of Panel with Buttons on right side -- START -->
        <bk-portlet-title [show_title]="false"
                          (onTabClick)="onToggleIDETab($event)"
                          [tab_selected_name] = "tab_under_ide"
                          [tabBtns]="[
                                {
                                    tab_name: 'error_list',
                                    tab_color: 'CODE',
                                    tab_label: ('tab_error_list'|bkTranslate:this)
                                },
                                {
                                    tab_name: 'console_log',
                                    tab_color: 'CODE',
                                    tab_label: ('tab_online_terminal'|bkTranslate:this)
                                },
                                {
                                    tab_name: 'versions',
                                    tab_color: 'CODE',
                                    tab_label: ('tab_versions'|bkTranslate:this)
                                }
                          ]">
        </bk-portlet-title>
        <!-- Portlet - Basic Title of Panel with Buttons on right side --- END -->

        <!--- Error Tabs -->
        <div *ngIf="tab_under_ide == 'error_list'">

            <div *ngIf="(buildErrors && buildErrors.length)">
                <div *ngFor="let buildError of buildErrors" class="mt-element-ribbon bg-grey-steel">
                    <div class="ribbon ribbon-shadow uppercase" [class.ribbon-color-danger]="buildError.type=='error'" [class.ribbon-color-warning]="buildError.type=='warning'">{{buildError.type}}</div>
                    <p class="ribbon-content">
                        <span [innerHTML]="'label_file_and_line'|bkTranslate:this:buildError.filename:buildError.line"></span>
                        <br>
                        <b>{{buildError.text}}</b>
                        <br>
                        <code>{{buildError.code}}</code>
                    </p>
                </div>
            </div>

            <!-- Temporary page content if content is being loaded or if there is no content -- START -->
            <bk-nothing-to-show [condition_loading]="(buildInProgress)"
                                [condition_empty]="(buildErrors != null && buildErrors.length == 0)"
                                [main_message_link]="'label_no_errors'|bkTranslate:this"
                                [main_message_comment_link]="'label_no_errors_description'|bkTranslate:this"
                                [show_button]="false">
            </bk-nothing-to-show>
            <!-- Temporary page content if content is being loaded or if there is no content -- END -->

        </div>
        <!--- Error Tabs END -->

        <div *ngIf="tab_under_ide == 'console_log'">
            Zatím nic....
        </div>


        <div *ngIf="tab_under_ide == 'versions'">
            <div *ngIf="codeProgramVersions.length > 0"  class="table-scrollable table-scrollable-borderless">
                <table class="table table-hover table-light byzance-table">
                    <thead>
                    <tr>
                        <th class="col col-lg-2">{{'table_name'|bkTranslate:this}}</th>
                        <th *ngIf="!projectId"></th>
                        <th class="col col-lg-6">{{'table_description'|bkTranslate:this}}</th>
                        <th class="col col-lg-6">{{'table_lib_version'|bkTranslate:this}}</th>
                        <th class="col col-lg-1">{{'table_author'|bkTranslate:this}}</th>
                        <th class="col col-lg-1">{{'table_status'|bkTranslate:this}}</th>
                        <th class="col col-lg-1"></th>
                        <th class="col col-lg-1 text-right no-wrap">{{'table_actions'|bkTranslate:this}} &nbsp;&nbsp;</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let version of codeProgramVersions">

                        <!-- NAME -->
                        <td class="vert-align bold" [class.bold]="isSelected(version)">
                            <a (click)="onProgramVersionClick(version)">
                                {{version.name}}
                            </a>

                            <!-- Main Mark - Only for settings for Type of Board, If C program is not for user projects -->
                        <td *ngIf="!projectId" class="vert-align">
                             <span class="icon-hint-wraper green" *ngIf="version.main_mark">
                                    <i class="fa fa-lg fa-flag font-green-jungle"></i>
                                    <span class="hint">{{'main_version'|bkTranslateTable:this:'version_status'}}</span>
                            </span>
                        </td>

                        <!-- Description -->
                        <td class="vert-align">
                            {{version.description}}
                        </td>

                        <!-- Description -->
                        <td class="vert-align">
                            {{version.compilation_version}}
                        </td>

                        <!-- Author -->
                        <td class="vert-align">
                            <span *ngIf="version.author">{{version.author.nick_name}}</span>
                            <span *ngIf="!version.author">No One</span>
                        </td>
                        <!-- STATUS -->
                        <td class="vert-align">
                            <bk-compilation-status-component [status]="version.status"></bk-compilation-status-component>
                            <bk-compilation-status-component [status]="version.approval_state"></bk-compilation-status-component>
                        </td>
                        <!-- UPLOAD -->

                        <td class="vert-align">
                            <button *ngIf="projectId && hardwareType && hardwareType.connectible_to_internet && version.status=='SUCCESS' && codeProgram && codeProgram.publish_type == 'PRIVATE'" class="btn blue">
                                {{'btn_upload_to_hardware'|bkTranslate:this}}
                            </button>
                        </td>

                        <!-- ACTIONS -->
                        <td class="vert-align text-right no-wrap">

                            <style type="text/css">
                                table tr button {
                                    opacity: 0.05;
                                }

                                table tr:hover button {
                                    opacity: 1
                                }
                            </style>


                            <a *ngIf="version.download_link_bin_file" href="{{version.download_link_bin_file}}">
                                <button title="{{'label_download_file'|bkTranslate:this}}" class="btn btn-icon-only blue">
                                    <i class="fa fa-cloud-download"></i>
                                </button>
                            </a>

                            <button *ngIf="version.update_permission"  title="{{'label_version_properties'|bkTranslate:this}}" class="btn btn-icon-only green"
                                    (click)="onEditVersionClick(version)">
                                <i class="fa fa-cog"></i>
                            </button>
                            <button *ngIf="codeProgram.publish_type == 'PRIVATE' && !version.approval_state" title="{{'label_version_properties'|bkTranslate:this}}" class="btn btn-icon-only blue-grey"
                                    (click)="onCommunityPublicVersionClick(version)">
                                <i class="fa fa-heart"></i>
                            </button>

                            <!-- Buttons for Administrator for Community decisions  -->
                            <button *ngIf="version.approval_state == 'PENDING' && version.community_publishing_permission" title="{{'label_publish'|bkTranslate:this}}" class="btn btn-icon-only green" (click)="onCProgramPublishResult(version)">
                                <i class="fa fa-heart"></i>
                            </button>

                            <button *ngIf="markupableAsMain(version)" title="{{'label_main_c_program_version_set_as_main'|bkTranslate:this}}" class="btn btn-icon-only yellow" [disabled]="hardwareType && !hardwareType.update_permission" (click)="onCProgramDefaultSetMainClick(version)">
                                <i class="fa fa-flag"></i>
                            </button>
                            <button title="{{'label_remove_version'|bkTranslate:this}}" class="btn btn-icon-only red" [disabled]="!version.delete_permission"
                                    (click)="onRemoveVersionClick(version)">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Temporary page content if content is being loaded or if there is no content -- START -->
            <bk-nothing-to-show [condition_loading]="(codeProgramVersions == null)"
                                [condition_empty]="(codeProgramVersions != null && codeProgramVersions.length == 0)"
                                [main_message_link]="'label_no_c_program_versions'|bkTranslate:this"
                                [main_message_comment_link]="'label_no_c_program_versions_comment'|bkTranslate:this"
                                [show_button]="false">
            </bk-nothing-to-show>
            <!-- Temporary page content if content is being loaded or if there is no content -- END -->

        </div>

    </div>
    <!-- Page Content UNDER IDE -- END -->

</bk-layout-main>
